<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
  <title>Altunga E-Spor & Cafe</title>
  <link rel="icon" type="image/png" href="logo.png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    /* --- MODERN GAMER THEME V2 --- */
    :root {
      --bg-dark: #0b0e14;
      --bg-panel: #151a23;
      --primary: #3b82f6; /* Mavi */
      --accent: #10b981;  /* Ye≈üil */
      --danger: #ef4444;
      --text-main: #ffffff;
      --text-muted: #94a3b8;
      --glass: rgba(21, 26, 35, 0.8);
      --border: rgba(255, 255, 255, 0.08);
      --glow: 0 0 20px rgba(59, 130, 246, 0.15);
      --font-body: 'Inter', sans-serif;
      --font-heading: 'Rajdhani', sans-serif;
    }

    /* Light Mode Deƒüi≈ükenleri */
    body.light-mode {
      --bg-dark: #f0f2f5;
      --bg-panel: #ffffff;
      --text-main: #111827;
      --text-muted: #6b7280;
      --glass: rgba(255, 255, 255, 0.8);
      --border: rgba(0, 0, 0, 0.05);
      --glow: 0 4px 20px rgba(0,0,0,0.05);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }

    body {
      background-color: var(--bg-dark);
      color: var(--text-main);
      font-family: var(--font-body);
      margin: 0; padding-bottom: 100px;
      overflow-x: hidden;
      transition: background 0.3s ease;
      background-image: 
        radial-gradient(circle at 0% 0%, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 100% 100%, rgba(16, 185, 129, 0.08) 0%, transparent 50%);
      background-attachment: fixed;
    }

    /* --- HEADER --- */
    header {
      background: var(--glass);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      padding: 15px 20px;
      position: sticky; top: 0; z-index: 100;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
    }

    .brand { display: flex; align-items: center; gap: 12px; }
    .brand img { height: 40px; width: auto; filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.4)); }
    .brand h1 {
      font-family: var(--font-heading);
      font-size: 1.4rem; font-weight: 700; margin: 0;
      text-transform: uppercase; letter-spacing: 1px;
      background: linear-gradient(to right, #fff, #94a3b8);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    body.light-mode .brand h1 { background: linear-gradient(to right, #111, #555); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

    .header-actions { display: flex; gap: 10px; }
    .icon-btn {
      background: var(--bg-panel); border: 1px solid var(--border);
      color: var(--text-main); width: 40px; height: 40px;
      border-radius: 12px; display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-size: 1.2rem; transition: 0.2s;
    }
    .icon-btn:active { transform: scale(0.95); }

    /* --- HERO SLIDER --- */
    .section-title {
      font-family: var(--font-heading);
      font-size: 1.2rem; color: var(--text-muted);
      margin: 25px 20px 15px; padding-left: 15px;
      border-left: 3px solid var(--accent);
      text-transform: uppercase; letter-spacing: 1px;
    }

    .slider-wrapper {
      overflow-x: auto; padding: 0 20px 20px;
      display: flex; gap: 15px;
      scrollbar-width: none;
    }
    .slider-wrapper::-webkit-scrollbar { display: none; }

    .slider-card {
      min-width: 150px; height: 200px;
      background: var(--bg-panel);
      border-radius: 16px; border: 1px solid var(--border);
      position: relative; overflow: hidden;
      box-shadow: var(--glow); cursor: pointer;
    }
    .slider-card img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; }
    .slider-info {
      position: absolute; bottom: 0; left: 0; width: 100%;
      background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
      padding: 20px 10px 10px; color: white;
    }
    .slider-info h3 { margin: 0; font-size: 0.9rem; font-weight: 600; }
    .slider-info span { color: var(--accent); font-weight: 700; font-size: 0.85rem; }

    /* --- ANA MEN√ú GRID --- */
    #menuGrid {
      display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 0 20px;
    }
    @media (min-width: 768px) { #menuGrid { grid-template-columns: repeat(4, 1fr); } }

    .category-card {
      background: var(--bg-panel); border: 1px solid var(--border);
      border-radius: 20px; padding: 20px;
      display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px;
      height: 140px; cursor: pointer; transition: 0.3s;
      position: relative; overflow: hidden;
    }
    .category-card:active { transform: scale(0.98); border-color: var(--primary); }
    .category-card::before {
      content: ''; position: absolute; inset: 0;
      background: radial-gradient(circle at 50% 100%, rgba(59,130,246,0.1), transparent);
      opacity: 0; transition: 0.3s;
    }
    .category-card:hover::before { opacity: 1; }
    
    .category-card img { width: 50px; height: 50px; object-fit: contain; z-index: 1; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.3)); }
    .category-card h3 { 
      margin: 0; font-size: 1rem; font-weight: 600; z-index: 1; 
      font-family: var(--font-heading); text-align: center;
    }

    /* --- MODAL (MEN√ú DETAY) --- */
    .modal {
      position: fixed; inset: 0; z-index: 2000;
      background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
      display: none; align-items: flex-end; /* Mobilde alttan gelsin */
    }
    .modal.active { display: flex; animation: fadeIn 0.2s; }
    @media (min-width: 768px) { .modal { align-items: center; justify-content: center; } }

    .modal-box {
      background: var(--bg-dark); width: 100%; max-height: 85vh;
      border-radius: 24px 24px 0 0; 
      display: flex; flex-direction: column;
      box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
      animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
    @media (min-width: 768px) { 
      .modal-box { width: 500px; border-radius: 24px; max-height: 80vh; } 
    }

    .modal-header {
      padding: 20px; border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center;
    }
    .modal-title { margin: 0; font-family: var(--font-heading); font-size: 1.5rem; color: var(--primary); }
    .close-btn { background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; }

    .modal-body { overflow-y: auto; padding: 20px; flex: 1; }

    /* Akordiyon Yapƒ± */
    .group-title {
      font-size: 0.85rem; text-transform: uppercase; color: var(--text-muted);
      margin: 20px 0 10px; font-weight: 700; letter-spacing: 1px;
      display: flex; align-items: center; gap: 10px;
    }
    .group-title::after { content:''; height: 1px; flex: 1; background: var(--border); }

    .product-list { display: flex; flex-direction: column; gap: 10px; }
    
    .product-item {
      display: flex; align-items: center; gap: 15px;
      background: var(--bg-panel); padding: 12px; border-radius: 12px;
      border: 1px solid var(--border); cursor: pointer; transition: 0.2s;
    }
    .product-item:active { background: rgba(59, 130, 246, 0.1); border-color: var(--primary); }
    
    .p-img { width: 50px; height: 50px; object-fit: contain; background: white; border-radius: 8px; padding: 2px; }
    .p-details { flex: 1; }
    .p-name { font-weight: 600; font-size: 0.95rem; display: block; }
    .p-price { color: var(--accent); font-weight: 700; font-size: 0.9rem; }
    .add-icon { 
      width: 32px; height: 32px; background: var(--border); border-radius: 50%; 
      display: flex; align-items: center; justify-content: center; color: var(--primary);
    }

    /* --- SEPET & FLOATING --- */
    .fab-container {
      position: fixed; bottom: 20px; left: 20px; right: 20px;
      display: flex; justify-content: space-between; pointer-events: none; z-index: 900;
    }
    .fab-btn {
      pointer-events: auto;
      height: 50px; border-radius: 25px; border: none;
      display: flex; align-items: center; justify-content: center; gap: 8px;
      font-family: var(--font-heading); font-weight: 700; font-size: 1rem;
      cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.3);
      transition: 0.2s;
    }
    .fab-call { width: 50px; background: var(--primary); color: white; border-radius: 50%; animation: pulse 2s infinite; }
    .fab-cart { 
      background: linear-gradient(135deg, #ef4444, #b91c1c); color: white; 
      padding: 0 25px;
    }
    
    /* Sepet Badge */
    .badge { 
      background: #ffd700; color: #000; font-size: 0.75rem; 
      padding: 2px 6px; border-radius: 10px; margin-left: 5px; 
    }

    /* Sepet Modal (Bottom Sheet gibi) */
    .cart-drawer {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--bg-panel); border-radius: 24px 24px 0 0;
      padding: 20px; z-index: 2100; transform: translateY(110%);
      transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      border-top: 1px solid var(--border);
      box-shadow: 0 -10px 50px rgba(0,0,0,0.5);
    }
    .cart-drawer.open { transform: translateY(0); }

    .cart-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 0; border-bottom: 1px solid var(--border);
    }
    .qty-btn { width: 24px; height: 24px; border-radius: 50%; border: 1px solid var(--border); background: transparent; color: var(--text-main); cursor: pointer; }

    .cart-input {
      width: 100%; padding: 12px; margin-top: 10px;
      background: var(--bg-dark); border: 1px solid var(--border);
      border-radius: 12px; color: var(--text-main); text-align: center;
    }

    .order-btn {
      width: 100%; padding: 15px; margin-top: 15px;
      background: var(--accent); color: white; border: none;
      border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer;
    }

    /* Animasyonlar */
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* Loader */
    #loader { text-align: center; padding: 50px; color: var(--text-muted); }
  </style>
</head>
<body>

  <header>
    <div class="brand">
      <img src="logo.png" alt="Altunga" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3210/3210036.png'">
      <h1>Altunga</h1>
    </div>
    <div class="header-actions">
      <button class="icon-btn" onclick="toggleTheme()" id="themeBtn">üåô</button>
      <button class="icon-btn" onclick="window.location.href='rezervasyon.html'">üìÖ</button>
    </div>
  </header>

  <h2 class="section-title">üî• Pop√ºler √úr√ºnler</h2>
  <div class="slider-wrapper" id="sliderWrapper">
    <div class="slider-card" onclick="sepeteEkle('Magnum Classic', 80)">
      <img src="populer/magnumclassicpopuler.png" onerror="this.src='https://images.unsplash.com/photo-1563227812-0ea4c22e6cc8?auto=format&fit=crop&q=80&w=300'">
      <div class="slider-info">
        <h3>Magnum Classic</h3>
        <span>‚Ç∫80</span>
      </div>
    </div>
    <div class="slider-card" onclick="sepeteEkle('Red Bull', 80)">
      <img src="populer/rebullpink.png" onerror="this.src='https://images.unsplash.com/photo-1626127117075-81768843a859?auto=format&fit=crop&q=80&w=300'">
      <div class="slider-info">
        <h3>Red Bull</h3>
        <span>‚Ç∫80</span>
      </div>
    </div>
     <div class="slider-card" onclick="sepeteEkle('Patso Men√º', 80)">
      <img src="populer/patsomenu.png" onerror="this.src='https://images.unsplash.com/photo-1623653387945-2fd25214f8fc?auto=format&fit=crop&q=80&w=300'">
      <div class="slider-info">
        <h3>Patso Men√º</h3>
        <span>‚Ç∫80</span>
      </div>
    </div>
  </div>

  <h2 class="section-title">üçî Men√º</h2>
  <div id="loader">Men√º Y√ºkleniyor...</div>
  <div id="menuGrid">
    </div>

  <div class="fab-container">
    <button class="fab-btn fab-call" onclick="openZilModal()">üîî</button>
    <button class="fab-btn fab-cart" onclick="toggleCart()">
      Sepet <span id="cartCount" class="badge">0</span>
    </button>
  </div>

  <div id="categoryModal" class="modal" onclick="if(event.target === this) closeMenu()">
    <div class="modal-box">
      <div class="modal-header">
        <h2 id="modalTitle" class="modal-title">Kategori</h2>
        <button class="close-btn" onclick="closeMenu()">√ó</button>
      </div>
      <div class="modal-body" id="modalBody">
        </div>
    </div>
  </div>

  <div id="cartDrawer" class="cart-drawer">
    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
      <h2 style="margin:0;">Sepetim</h2>
      <button onclick="toggleCart()" style="background:none; border:none; color:var(--danger); font-weight:bold;">Kapat</button>
    </div>
    <div id="cartItems" style="max-height: 40vh; overflow-y: auto;"></div>
    
    <div style="margin-top:15px; border-top:1px solid var(--border); padding-top:10px;">
      <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:1.1rem;">
        <span>Toplam:</span>
        <span id="cartTotal" style="color:var(--accent)">‚Ç∫0</span>
      </div>
      
      <div id="cartInputs" style="display:none;">
        <input type="text" id="masaInput" class="cart-input" placeholder="Masa No (√ñrn: H√ºma 5)">
        <input type="text" id="odaInput" class="cart-input" placeholder="Oda No (√ñrn: Vip 2)">
        <button class="order-btn" onclick="siparisVer()">Sipari≈üi Tamamla</button>
      </div>
      <div id="emptyMsg" style="text-align:center; color:var(--text-muted); margin-top:10px;">Sepetiniz bo≈ü</div>
    </div>
  </div>

  <div id="zilModal" class="modal" onclick="if(event.target === this) closeZilModal()">
    <div class="modal-box" style="height:auto; padding-bottom:30px;">
      <div class="modal-header">
        <h2 class="modal-title">G√∂revli √áaƒüƒ±r</h2>
        <button class="close-btn" onclick="closeZilModal()">√ó</button>
      </div>
      <div style="padding:20px; display:grid; gap:10px;">
        <p style="text-align:center; color:var(--text-muted);">Hangi konuda destek istiyorsunuz?</p>
        <button onclick="sendCall('Bili≈üim')" class="order-btn" style="background:var(--primary)">üíª Bili≈üim / Teknik</button>
        <button onclick="sendCall('Sipari≈ü')" class="order-btn" style="background:var(--accent)">üßæ Sipari≈ü / Hesap</button>
        
        <div id="zilInputs" style="display:none; margin-top:10px;">
           <input type="text" id="zilMasa" class="cart-input" placeholder="Masa No Giriniz">
           <button class="order-btn" style="background:var(--danger)" onclick="confirmCall()">√áaƒürƒ± G√∂nder</button>
        </div>
      </div>
    </div>
  </div>

  <audio id="dingSound" src="ding.mp3" preload="auto"></audio>

  <script>
    // --- FIREBASE AYARLARI ---
    const firebaseConfig = {
      apiKey: "AIzaSyC2kYwYuv7drDw0zViXYN4DqpppbtP_coY",
      authDomain: "altunga-siparis.firebaseapp.com",
      databaseURL: "https://altunga-siparis-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "altunga-siparis",
      storageBucket: "altunga-siparis.appspot.com",
      messagingSenderId: "152830720353",
      appId: "1:152830720353:web:cc3d3646e6a859c0ca2d20",
      measurementId: "G-JKXK55E39H"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- STATE & DATA ---
    let menuData = {}; 
    let cart = [];
    let currentCallType = "";

    // --- INIT ---
    document.addEventListener("DOMContentLoaded", () => {
      fetchMenu();
      checkUrlParams();
    });

    // --- 1. VERƒ∞ √áEKME & ƒ∞≈ûLEME (Dƒ∞NAMƒ∞K YAPI) ---
    async function fetchMenu() {
      try {
        const snapshot = await db.collection("menu_items").get();
        const grid = document.getElementById("menuGrid");
        document.getElementById("loader").style.display = "none";
        
        // Veriyi sƒ±fƒ±rla
        menuData = {};
        
        snapshot.forEach(doc => {
          const item = doc.data();
          const catName = item.category.trim(); // "ƒ∞√ßecekler"
          const catKey = sanitizeKey(catName);  // "icecekler" (ID i√ßin)

          // Eƒüer bu kategori nesnede yoksa olu≈ütur
          if (!menuData[catKey]) {
            menuData[catKey] = {
              title: catName,
              groups: {} // Gruplarƒ± tutacak (√ñrn: Gazlƒ± ƒ∞√ßecekler)
            };
          }

          // Grubu al
          const groupName = item.group || "Diƒüer";
          
          if (!menuData[catKey].groups[groupName]) {
            menuData[catKey].groups[groupName] = [];
          }

          // √úr√ºn√º listeye ekle
          menuData[catKey].groups[groupName].push({
            name: item.name_tr,
            price: item.price,
            image: item.image
          });
        });

        // Grid'i Olu≈ütur (Kategori Kutularƒ±)
        renderGrid();

      } catch (error) {
        console.error("Hata:", error);
        document.getElementById("loader").innerText = "Men√º y√ºklenemedi!";
      }
    }

    function sanitizeKey(str) {
      // T√ºrk√ße karakterleri ve bo≈üluklarƒ± temizleyip ID yapar
      const map = { 'ƒ∞': 'i', 'I': 'i', '≈û': 's', 'ƒû': 'g', '√ú': 'u', '√ñ': 'o', '√á': 'c', 'ƒ±': 'i', '≈ü': 's', 'ƒü': 'g', '√º': 'u', '√∂': 'o', '√ß': 'c' };
      return str.replace(/[ƒ∞I≈ûƒû√ú√ñ√áƒ±≈üƒü√º√∂√ß]/g, (s) => map[s]).toLowerCase().replace(/[^a-z0-9]/g, '');
    }

    // --- 2. RENDER (G√ñR√úNT√úLEME) ---
    function renderGrid() {
      const grid = document.getElementById("menuGrid");
      grid.innerHTML = "";

      // Kategori Resimleri (Sabit veya ƒ∞kon)
      const catImages = {
        'icecekler': 'icecekler.png',
        'atistirmalik': 'cips.png',
        'sekerleme': 'jelibon.png',
        'fastfood': 'patso.png',
        'dondurma': 'dondurma.png',
        'doner': 'doner.png',
        'tost': 'tost.png'
      };

      Object.keys(menuData).forEach(key => {
        const cat = menuData[key];
        const img = catImages[key] || 'logo.png'; // Resim yoksa logo koy

        const card = document.createElement("div");
        card.className = "category-card";
        card.onclick = () => openMenu(key);
        card.innerHTML = `
          <img src="${img}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/706/706164.png'">
          <h3>${cat.title}</h3>
        `;
        grid.appendChild(card);
      });
    }

    function openMenu(key) {
      const cat = menuData[key];
      if (!cat) return;

      document.getElementById("modalTitle").innerText = cat.title;
      const body = document.getElementById("modalBody");
      body.innerHTML = "";

      // Gruplarƒ± d√∂n
      Object.keys(cat.groups).forEach(groupName => {
        // Grup Ba≈ülƒ±ƒüƒ±
        const title = document.createElement("div");
        title.className = "group-title";
        title.innerText = groupName;
        body.appendChild(title);

        // √úr√ºn Listesi
        const listDiv = document.createElement("div");
        listDiv.className = "product-list";

        cat.groups[groupName].forEach(item => {
          const itemDiv = document.createElement("div");
          itemDiv.className = "product-item";
          itemDiv.onclick = () => sepeteEkle(item.name, item.price);
          itemDiv.innerHTML = `
            <img src="${item.image || 'default.png'}" class="p-img" onerror="this.style.opacity=0">
            <div class="p-details">
              <span class="p-name">${item.name}</span>
              <span class="p-price">‚Ç∫${item.price}</span>
            </div>
            <div class="add-icon">+</div>
          `;
          listDiv.appendChild(itemDiv);
        });
        body.appendChild(listDiv);
      });

      document.getElementById("categoryModal").classList.add("active");
    }

    function closeMenu() {
      document.getElementById("categoryModal").classList.remove("active");
    }

    // --- 3. SEPET ƒ∞≈ûLEMLERƒ∞ ---
    function sepeteEkle(name, price) {
      const existing = cart.find(i => i.name === name);
      if (existing) {
        existing.qty++;
      } else {
        cart.push({ name, price, qty: 1 });
      }
      // Ufak bildirim
      const btn = document.querySelector(".fab-cart");
      btn.style.transform = "scale(1.1)";
      setTimeout(() => btn.style.transform = "scale(1)", 200);
      
      updateCartUI();
    }

    function updateCartUI() {
      const count = cart.reduce((a, b) => a + b.qty, 0);
      const total = cart.reduce((a, b) => a + (b.price * b.qty), 0);
      
      document.getElementById("cartCount").innerText = count;
      document.getElementById("cartTotal").innerText = "‚Ç∫" + total;

      const list = document.getElementById("cartItems");
      list.innerHTML = "";

      if (cart.length === 0) {
        document.getElementById("emptyMsg").style.display = "block";
        document.getElementById("cartInputs").style.display = "none";
      } else {
        document.getElementById("emptyMsg").style.display = "none";
        document.getElementById("cartInputs").style.display = "block";

        cart.forEach((item, idx) => {
          const div = document.createElement("div");
          div.className = "cart-item";
          div.innerHTML = `
            <div>
              <div style="font-weight:600">${item.name}</div>
              <div style="font-size:0.85rem; color:var(--accent)">‚Ç∫${item.price}</div>
            </div>
            <div style="display:flex; align-items:center; gap:8px;">
              <button class="qty-btn" onclick="updateQty(${idx}, -1)">-</button>
              <span>${item.qty}</span>
              <button class="qty-btn" onclick="updateQty(${idx}, 1)">+</button>
            </div>
          `;
          list.appendChild(div);
        });
      }
    }

    function updateQty(idx, change) {
      cart[idx].qty += change;
      if (cart[idx].qty <= 0) cart.splice(idx, 1);
      updateCartUI();
    }

    function toggleCart() {
      document.getElementById("cartDrawer").classList.toggle("open");
    }

    // --- 4. Sƒ∞PARƒ∞≈û & Zƒ∞L ---
    async function siparisVer() {
      const masa = document.getElementById("masaInput").value.trim();
      const oda = document.getElementById("odaInput").value.trim();

      if (!masa && !oda) {
        alert("L√ºtfen Masa veya Oda numaranƒ±zƒ± giriniz!");
        return;
      }

      const orderData = {
        masa, oda,
        items: cart,
        total: cart.reduce((a, b) => a + (b.price * b.qty), 0),
        status: "Beklemede",
        timestamp: new Date()
      };

      try {
        await db.collection("siparisler").add(orderData);
        alert("‚úÖ Sipari≈üiniz Alƒ±ndƒ±! Afiyet olsun.");
        cart = [];
        updateCartUI();
        toggleCart();
        // Masa bilgisini hatƒ±rla
        localStorage.setItem("masaNo", masa);
        localStorage.setItem("odaNo", oda);
      } catch (e) {
        alert("Hata olu≈ütu: " + e.message);
      }
    }

    function openZilModal() {
      document.getElementById("zilModal").classList.add("active");
      document.getElementById("zilInputs").style.display = "none";
    }
    function closeZilModal() {
      document.getElementById("zilModal").classList.remove("active");
    }
    
    function sendCall(type) {
        currentCallType = type;
        const storedMasa = localStorage.getItem("masaNo");
        if(storedMasa) {
            document.getElementById("zilMasa").value = storedMasa;
        }
        document.getElementById("zilInputs").style.display = "block";
    }

    function confirmCall() {
        const masa = document.getElementById("zilMasa").value;
        if(!masa) { alert("Masa no giriniz"); return; }
        
        db.collection("cagrilar").add({
            tip: currentCallType,
            masa: masa,
            zaman: new Date()
        }).then(() => {
            alert(currentCallType + " g√∂revlisi √ßaƒürƒ±ldƒ±!");
            closeZilModal();
            document.getElementById("dingSound").play().catch(e=>{});
        });
    }

    // --- YARDIMCI ---
    function checkUrlParams() {
      const p = new URLSearchParams(window.location.search);
      const m = p.get('masa');
      const o = p.get('oda');
      if (m) { document.getElementById("masaInput").value = m; localStorage.setItem("masaNo", m); }
      if (o) { document.getElementById("odaInput").value = o; localStorage.setItem("odaNo", o); }
      
      const storedM = localStorage.getItem("masaNo");
      if(storedM) {
          document.getElementById("masaInput").value = storedM;
          document.getElementById("zilMasa").value = storedM;
      }
    }

    function toggleTheme() {
      document.body.classList.toggle("light-mode");
    }
  </script>
</body>
</html>
