<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Masal Ünitesi - Dallanmış Ağaç</title>
    <script src="https://cdn.jsdelivr.net/npm/jsplumb@2.15.6/dist/js/jsplumb.min.js"></script>

    <style>
        /* 1. TEMEL AYARLAR */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #f0f2f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none;
            -webkit-user-select: none;
        }

        /* --- ÜST PANEL (HEADER) --- */
        #top-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: auto;
            min-height: 70px;
            padding: 10px 20px;
            box-sizing: border-box;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 2000;
            pointer-events: none;
            background: rgba(240, 242, 245, 0.85);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        #top-bar > * { pointer-events: auto; }

        /* BAŞLIK */
        #main-title {
            background: #ffffff;
            color: #2c3e50;
            font-size: 18px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 8px 20px;
            border-radius: 50px;
            border: 2px solid #34495e;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* YÖNERGE BUTONU */
        #instruction-btn {
            background: #3498db;
            color: white;
            font-size: 15px;
            font-weight: bold;
            padding: 8px 25px;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.4);
            transition: transform 0.2s, background 0.2s;
            text-transform: uppercase;
        }

        #instruction-btn:hover { transform: scale(1.05); background: #2980b9; }

        /* MP3 PLAYER */
        #audio-player-container {
            background: white;
            padding: 4px;
            border-radius: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border: 1px solid #e1e4e8;
            display: flex;
            align-items: center;
        }
        
        audio { height: 32px; outline: none; }

        /* --- MODAL --- */
        #modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(3px);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }

        #modal-box {
            background: white;
            padding: 25px;
            border-radius: 15px;
            width: 85%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            position: relative;
            animation: slideDown 0.3s ease-out;
        }

        #modal-title {
            color: #2c3e50;
            font-size: 20px;
            font-weight: 900;
            margin-bottom: 15px;
            text-transform: uppercase;
            border-bottom: 2px solid #f0f2f5;
            padding-bottom: 10px;
        }

        #modal-text {
            color: #555;
            font-size: 15px;
            line-height: 1.5;
            margin-bottom: 20px;
        }

        #modal-close-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 5px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
        }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }

        /* YENİDEN BAŞLAT */
        #restart-btn {
            position: fixed;
            bottom: 30px;
            left: 50%;   
            transform: translateX(-50%);
            z-index: 2000;
            background: linear-gradient(135deg, #ff9f43, #ee5253);
            color: white;
            border: none;
            padding: 12px 32px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 700;
            display: none; 
            align-items: center;
            gap: 12px;
            box-shadow: 0 10px 20px rgba(238, 82, 83, 0.4);
            cursor: pointer;
            transition: all 0.3s;
        }
        .restart-icon { width: 22px; height: 22px; fill: currentColor; }

        /* --- KANVAS --- */
        #canvas {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            overflow: auto;
            background-color: #fdfdfd;
            background-image: linear-gradient(#e0e0e0 1px, transparent 1px), linear-gradient(90deg, #e0e0e0 1px, transparent 1px);
            background-size: 20px 20px;
            cursor: grab;
            touch-action: none; 
        }

        #canvas:active { cursor: grabbing; }
        #canvas::-webkit-scrollbar { display: none; }
        #canvas { -ms-overflow-style: none; scrollbar-width: none; }

        #ghost-element {
            position: absolute;
            width: 1px;
            height: 1px;
            top: 5000px;
            left: 5000px;
            visibility: hidden;
        }

        /* --- NODE --- */
        .node {
            position: absolute;
            width: 240px;
            background: #ffffff;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid #e1e4e8;
            z-index: 10;
            display: flex;
            align-items: center;
            min-height: 90px;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .node-text { font-size: 14px; color: #333; pointer-events: none; line-height: 1.4; }
        .node.exit {
            background: #fff8e1;
            border: 2px solid #f1c40f;
            color: #d35400;
            justify-content: center;
            text-align: center;
            font-weight: bold;
            flex-direction: column;
            gap: 5px;
        }
        .correct-exit { background: #e8f8f5 !important; border-color: #2ecc71 !important; color: #27ae60 !important; }
        
        .btn-group {
            position: absolute;
            right: -22px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 20;
        }
        .choice-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.1s;
        }
        .choice-btn:active { transform: scale(0.9); }
        .btn-d { background-color: #2ecc71; }
        .btn-y { background-color: #e74c3c; }
        .choice-btn:disabled { background-color: #bdc3c7; opacity: 0.6; pointer-events: none; }

        @keyframes popIn { 0% { opacity: 0; transform: scale(0.5); } 100% { opacity: 1; transform: scale(1); } }
        
        /* MOBİL */
        @media (max-width: 768px) {
            #top-bar { flex-direction: column; gap: 8px; padding: 10px; }
            #main-title { font-size: 14px; padding: 5px 15px; order: 1; width: auto; }
            #instruction-btn { order: 2; padding: 6px 20px; font-size: 13px; }
            #audio-player-container { order: 3; width: auto; justify-content: center; }
            audio { width: 240px; height: 30px; }
        }
    </style>
</head>
<body>

<div id="top-bar">
    <div id="main-title">DALLANMIŞ AĞAÇ: MASAL</div>
    <button id="instruction-btn" onclick="openModal()">Yönerge</button>
    <div id="audio-player-container">
        <audio controls>
            <source src="ayagina_diken_batan_serce.mp3" type="audio/mpeg">
            Tarayıcınız ses dosyasını desteklemiyor.
        </audio>
    </div>
</div>

<div id="modal-overlay" onclick="closeModal()">
    <div id="modal-box" onclick="event.stopPropagation()">
        <div id="modal-title">YÖNERGE</div>
        <div id="modal-text">
            Dinlediğiniz masaldan yola çıkarak verilen önermenin doğru olduğunu düşünüyorsanız (D), 
            yanlış olduğunu düşünüyorsanız (Y) seçeneğini işaretlemeniz gerekmektedir. 
            İlk önermeden başlayarak yapacağınız seçimlerle ve oklar yönünde ilerleyerek bir çıkış noktasını belirleyiniz.
        </div>
        <button id="modal-close-btn" onclick="closeModal()">Anlaşıldı, Kapat</button>
    </div>
</div>

<button id="restart-btn" onclick="restartGame()">
    <svg class="restart-icon" viewBox="0 0 24 24">
        <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
    </svg>
    Yeniden Başla
</button>

<div id="canvas">
    <div id="ghost-element"></div>
</div>

<script>
    const treeData = {
        "start": { text: "1. Masal; olağanüstü ögeler içeren bir türdür.", d: "q2", y: "q3", level: 0 },
        "q2": { text: "2. Masalda kişiler ayrıntılı şekilde betimlenir.", d: "q4", y: "q5", level: 1, direction: 'up' },
        "q3": { text: "3. Masalda millî değerler işlenir.", d: "q6", y: "q7", level: 1, direction: 'down' },
        "q4": { text: "4. Masal, dinleyicinin ilgisini çeken bir tekerlemeyle başlar.", d: "exit1", y: "exit2", level: 2, direction: 'up' },
        "q5": { text: "5. Masal, iyi dilek bildiren kalıplaşmış sözlerle son bulur.", d: "exit3", y: "exit4", level: 2, direction: 'mid-up' },
        "q6": { text: "6. Masalın sonunda iyiler kazanır, kötüler cezalandırılır.", d: "exit5", y: "exit6", level: 2, direction: 'mid-down' },
        "q7": { text: "7. Masalda olayların geçtiği zaman belirsizdir.", d: "exit7", y: "exit8", level: 2, direction: 'down' },
        "exit1": { text: "1. ÇIKIŞ", points: "50 Puan", type: "exit", level: 3 },
        "exit2": { text: "2. ÇIKIŞ", points: "25 Puan", type: "exit", level: 3 },
        "exit3": { text: "3. ÇIKIŞ", points: "100 Puan", type: "exit", level: 3, isCorrect: true },
        "exit4": { text: "4. ÇIKIŞ", points: "75 Puan", type: "exit", level: 3 },
        "exit5": { text: "5. ÇIKIŞ", points: "10 Puan", type: "exit", level: 3 },
        "exit6": { text: "6. ÇIKIŞ", points: "40 Puan", type: "exit", level: 3 },
        "exit7": { text: "7. ÇIKIŞ", points: "60 Puan", type: "exit", level: 3 },
        "exit8": { text: "8. ÇIKIŞ", points: "20 Puan", type: "exit", level: 3 }
    };

    let jspInstance;
    const CENTER_X = 2500;
    const CENTER_Y = 2500;

    function openModal() { document.getElementById("modal-overlay").style.display = "flex"; }
    function closeModal() { document.getElementById("modal-overlay").style.display = "none"; }

    jsPlumb.ready(function() {
        jspInstance = jsPlumb.getInstance({
            Connector: ["Bezier", { curviness: 50 }],
            PaintStyle: { stroke: "#95a5a6", strokeWidth: 3 },
            Endpoint: ["Dot", { radius: 2 }],
            EndpointStyle: { fill: "#95a5a6" },
            Container: "canvas"
        });
        startGame();
        setupDragToScroll();
    });

    function startGame() {
        createNode("start", null, null, CENTER_X, CENTER_Y);
        centerScreen(CENTER_X, CENTER_Y);
    }

    function restartGame() {
        document.getElementById("restart-btn").style.display = "none";
        jspInstance.deleteEveryConnection();
        jspInstance.deleteEveryEndpoint();
        const ghost = document.getElementById("ghost-element");
        const canvas = document.getElementById("canvas");
        canvas.innerHTML = "";
        canvas.appendChild(ghost); 
        startGame();
    }

    // --- DÜZELTİLMİŞ ODAKLANMA FONKSİYONU ---
    function centerScreen(targetX, targetY) {
        const canvas = document.getElementById("canvas");
        const viewportW = window.innerWidth;
        const viewportH = window.innerHeight;
        
        let scrollX, scrollY;

        if (window.innerWidth > 768) {
            // --- PC MODU ---
            // Yatay: Sol kenara yasla (100px içeriden)
            scrollX = targetX - 100;
            // Dikey: Ekranın tam ortası (+50px hafif aşağısı, estetik duruş)
            // Header hesabına girmiyoruz çünkü PC'de yer bol.
            scrollY = targetY - (viewportH / 2) + 50; 
        } else {
            // --- MOBİL MOD ---
            // Yatay: Tam ortala
            scrollX = targetX - (viewportW / 2) + 120;
            
            // Dikey: Header yüksekliğini düş, kalanın ortasını bul
            const topBar = document.getElementById("top-bar");
            const headerHeight = topBar ? topBar.offsetHeight : 0;
            
            // Ekranın yarısı kadar geri git, header'ın yarısı kadar aşağı in (dengelemek için)
            // +20px ince ayar
            scrollY = targetY - (viewportH / 2) - (headerHeight / 2) + 20; 
        }

        setTimeout(() => {
            canvas.scrollTo({ left: scrollX, top: scrollY, behavior: 'smooth' });
        }, 50);
    }

    function getCoordinates(parentId, level, branchType) {
        const parentEl = document.getElementById(parentId);
        const pLeft = parseInt(parentEl.style.left);
        const pTop = parseInt(parentEl.style.top);

        const xStep = 320; 
        const newLeft = pLeft + xStep;
        
        let gap = 0;
        if (level === 1) gap = 240;
        else if (level === 2) gap = 140;
        else if (level === 3) gap = 80;

        let newTop = pTop;
        if (branchType === 'D') newTop = pTop - gap;
        else newTop = pTop + gap;

        return { left: newLeft, top: newTop };
    }

    function createNode(nodeId, parentId, fromButtonType, startX, startY) {
        const data = treeData[nodeId];
        if (!data) return;

        const nodeDiv = document.createElement("div");
        nodeDiv.id = nodeId;
        
        let classes = "node";
        if (data.type === "exit") {
            classes += " exit";
            if (data.isCorrect) classes += " correct-exit";
        }
        nodeDiv.className = classes;
        
        const textSpan = document.createElement("span");
        textSpan.className = "node-text";
        textSpan.innerText = data.text;
        nodeDiv.appendChild(textSpan);

        if (data.type === "exit") {
            const pointSpan = document.createElement("div");
            pointSpan.style.fontSize = "18px";
            pointSpan.innerText = data.points;
            nodeDiv.appendChild(pointSpan);
            const restartBtn = document.getElementById("restart-btn");
            restartBtn.style.display = "flex"; 
        }

        if (data.type !== "exit") {
            const btnGroup = document.createElement("div");
            btnGroup.className = "btn-group";
            const btnD = document.createElement("button");
            btnD.className = "choice-btn btn-d";
            btnD.innerText = "D";
            btnD.ontouchstart = function(e) { e.stopPropagation(); handleChoice(nodeId, data.d, 'D', btnD, btnY); };
            btnD.onclick = function(e) { e.stopPropagation(); handleChoice(nodeId, data.d, 'D', btnD, btnY); };
            const btnY = document.createElement("button");
            btnY.className = "choice-btn btn-y";
            btnY.innerText = "Y";
            btnY.ontouchstart = function(e) { e.stopPropagation(); handleChoice(nodeId, data.y, 'Y', btnY, btnD); };
            btnY.onclick = function(e) { e.stopPropagation(); handleChoice(nodeId, data.y, 'Y', btnY, btnD); };
            btnGroup.appendChild(btnD);
            btnGroup.appendChild(btnY);
            nodeDiv.appendChild(btnGroup);
        }

        let coords;
        if (parentId) {
            coords = getCoordinates(parentId, data.level, fromButtonType);
        } else {
            coords = { left: startX, top: startY };
        }

        nodeDiv.style.left = coords.left + "px";
        nodeDiv.style.top = coords.top + "px";
        document.getElementById("canvas").appendChild(nodeDiv);

        if (parentId) {
            jspInstance.connect({
                source: parentId,
                target: nodeId,
                anchors: ["Right", "Left"],
                overlays: [ ["Arrow", { width: 10, length: 10, location: 1 }] ]
            });
            if (window.innerWidth <= 768) {
                centerScreen(coords.left, coords.top);
            }
        }
    }

    function handleChoice(currentId, targetId, choiceType, clickedBtn, otherBtn) {
        clickedBtn.disabled = true;
        otherBtn.disabled = true;
        createNode(targetId, currentId, choiceType);
    }

    function setupDragToScroll() {
        const ele = document.getElementById('canvas');
        let pos = { top: 0, left: 0, x: 0, y: 0 };
        const mouseDownHandler = function(e) {
            if(e.target.closest('button')) return;
            ele.style.cursor = 'grabbing';
            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;
            pos = { left: ele.scrollLeft, top: ele.scrollTop, x: clientX, y: clientY };
            document.addEventListener('mousemove', mouseMoveHandler);
            document.addEventListener('mouseup', mouseUpHandler);
            document.addEventListener('touchmove', mouseMoveHandler, { passive: false });
            document.addEventListener('touchend', mouseUpHandler);
        };
        const mouseMoveHandler = function(e) {
            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;
            const dx = clientX - pos.x;
            const dy = clientY - pos.y;
            ele.scrollTop = pos.top - dy;
            ele.scrollLeft = pos.left - dx;
            if(e.type === 'touchmove') e.preventDefault(); 
        };
        const mouseUpHandler = function() {
            ele.style.cursor = 'grab';
            document.removeEventListener('mousemove', mouseMoveHandler);
            document.removeEventListener('mouseup', mouseUpHandler);
            document.removeEventListener('touchmove', mouseMoveHandler);
            document.removeEventListener('touchend', mouseUpHandler);
        };
        ele.addEventListener('mousedown', mouseDownHandler);
        ele.addEventListener('touchstart', mouseDownHandler);
    }
</script>
</body>
</html>