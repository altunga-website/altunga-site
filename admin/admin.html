<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Altunga Y√∂netim Paneli</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root {
      --bg-body: #f1f5f9; --bg-card: #ffffff; --text-main: #1e293b; --text-muted: #64748b;
      --border: #e2e8f0; --primary: #3b82f6; --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); --radius: 16px;
    }
    body.dark {
      --bg-body: #0f172a; --bg-card: #1e293b; --text-main: #f1f5f9; --text-muted: #94a3b8;
      --border: rgba(255, 255, 255, 0.08); --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
    }

    * { box-sizing: border-box; outline: none; }
    body { font-family: 'Poppins', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; padding: 20px; transition: 0.3s; }

    /* Header & Controls */
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
    .header h1 { margin: 0; font-size: 1.5rem; }
    .controls { display: flex; gap: 10px; align-items: center; }
    .controls button, .controls select { background: var(--bg-card); border: 1px solid var(--border); color: var(--text-main); padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 500; transition: 0.2s; font-family: inherit;}
    .controls button:hover { background: var(--border); }

    /* Login Screen */
    #girisOverlay { position: fixed; inset: 0; background: var(--bg-body); z-index: 10000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    #girisSecim { background: var(--bg-card); padding: 30px; border-radius: var(--radius); text-align: center; box-shadow: var(--shadow); width: 90%; max-width: 400px; border: 1px solid var(--border); }
    .giris-btn { width: 100%; padding: 12px; margin: 8px 0; border: none; border-radius: 10px; font-weight: 600; color: white; cursor: pointer; font-size: 1rem; }
    .admin-btn { background: var(--primary); }
    .kasiyer-btn { background: var(--text-muted); }
    
    #sifreBox { display: none; margin-top: 20px; }
    #sifreInput { width: 100%; padding: 10px; font-size: 1.5rem; text-align: center; margin-bottom: 15px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-body); color: var(--text-main); }
    #pinPad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    #pinPad button { padding: 15px; font-size: 1.2rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-body); color: var(--text-main); cursor: pointer; }
    .pin-clear { background: var(--danger) !important; color: white !important; }

    /* --- SIPARIS KARTLARI (Grid) --- */
    .section-title { font-size: 1.2rem; font-weight: 600; margin: 30px 0 15px 0; border-bottom: 2px solid var(--border); padding-bottom: 10px; display:flex; align-items:center; gap:10px; }
    .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
    
    .order-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); position: relative; animation: slideIn 0.3s ease; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    
    .card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 10px; }
    .masa-badge { background: var(--primary); color: white; padding: 4px 10px; border-radius: 6px; font-weight: 700; font-size: 0.9rem; }
    .time-badge { font-size: 0.8rem; color: var(--text-muted); }
    
    .product-list { margin-bottom: 15px; font-size: 0.95rem; max-height: 200px; overflow-y: auto; }
    .product-item { display: flex; justify-content: space-between; border-bottom: 1px solid var(--border); padding: 6px 0; }
    
    .card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: auto; padding-top: 10px; border-top: 1px solid var(--border); }
    .total-price { font-size: 1.2rem; font-weight: 700; color: var(--success); }
    
    .actions { display: flex; gap: 5px; margin-top: 15px; }
    .btn-action { flex: 1; padding: 10px; border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: 0.2s; }
    .btn-prep { background: var(--warning); }
    .btn-done { background: var(--success); }
    .btn-cancel { background: var(--text-muted); flex:0.4; }
    .btn-del { background: var(--danger); flex:0.4; }

    /* --- √áAƒûRI KARTLARI (Grid) --- */
    .call-card { 
        background: var(--bg-card); border: 1px solid var(--danger); border-left: 5px solid var(--danger);
        border-radius: var(--radius); padding: 15px; box-shadow: var(--shadow);
        display: flex; align-items: center; justify-content: space-between;
        animation: pulse 2s infinite; 
    }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

    .call-info { display: flex; align-items: center; gap: 15px; }
    .call-icon { font-size: 2rem; }
    .call-details h3 { margin: 0; font-size: 1rem; color: var(--text-main); }
    .call-details p { margin: 0; font-size: 0.85rem; color: var(--text-muted); }

    /* Alert */
    .custom-alert { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 30px; z-index: 11000; opacity: 0; pointer-events: none; transition: 0.3s; }
    .custom-alert.show { opacity: 1; top: 30px; }

    @media (max-width: 600px) {
        .header { flex-direction: column; align-items: stretch; }
        .controls { overflow-x: auto; padding-bottom: 5px; }
    }
  </style>
</head>
<body>

  <audio id="ding" src="ding.mp3" preload="auto"></audio>
  <div id="customAlert" class="custom-alert"></div>

  <div id="girisOverlay">
    <div id="girisSecim">
      <h2 style="color:var(--text-main)">Altunga Y√∂netim</h2>
      <button class="giris-btn admin-btn" onclick="hazirla('admin')">üóùÔ∏è Y√∂netici</button>
      <button class="giris-btn kasiyer-btn" onclick="hazirla('kasiyer1')">üë§ Kasiyer Cafer</button>
      <button class="giris-btn kasiyer-btn" onclick="hazirla('kasiyer2')">üë§ Kasiyer Mustafa</button>

      <div id="sifreBox">
        <input type="password" id="sifreInput" readonly placeholder="******">
        <div id="pinPad">
          <button onclick="pinYaz('1')">1</button><button onclick="pinYaz('2')">2</button><button onclick="pinYaz('3')">3</button>
          <button onclick="pinYaz('4')">4</button><button onclick="pinYaz('5')">5</button><button onclick="pinYaz('6')">6</button>
          <button onclick="pinYaz('7')">7</button><button onclick="pinYaz('8')">8</button><button onclick="pinYaz('9')">9</button>
          <button class="pin-clear" onclick="pinSil()">C</button><button onclick="pinYaz('0')">0</button><button style="background:var(--success); color:white" onclick="girisYap()">OK</button>
        </div>
        <button onclick="iptalGiris()" style="margin-top:10px; background:transparent; border:none; color:var(--text-muted); cursor:pointer">Geri D√∂n</button>
      </div>
    </div>
  </div>

  <div class="header">
    <div>
      <h1>Sipari≈ü Y√∂netimi</h1>
      <div id="aktifKullanici" style="font-size:0.9rem; color:var(--text-muted)"></div>
    </div>
    <div class="controls">
      <button onclick="toggleDarkMode()">üåô Tema</button>
      <select id="durumFiltre" onchange="listeleSiparisler()">
        <option value="T√ºm√º">T√ºm Sipari≈üler</option>
        <option value="Beklemede">Beklemede</option>
        <option value="Hazirlaniyor">Hazƒ±rlanƒ±yor</option>
      </select>
      <button onclick="window.open('arsiv.html', '_blank')">üì¶ Ar≈üiv</button>
      <button onclick="cikisYap()" style="color:var(--danger); border-color:var(--danger)">√áƒ±kƒ±≈ü</button>
    </div>
  </div>

  <div class="section-title">üìù Sipari≈üler</div>
  <div class="grid-container" id="siparisListesi">
    </div>

  <div id="callsSection" style="display:none; margin-top:40px;">
      <div class="section-title" style="border-color:var(--danger)">üîî Garson √áaƒürƒ±larƒ±</div>
      <div class="grid-container" id="cagriListesi"></div>
  </div>

<script>
// --- FIREBASE AYARLARI ---
const firebaseConfig = {
  apiKey: "AIzaSyC2kYwYuv7drDw0zViXYN4DqpppbtP_coY",
  authDomain: "altunga-siparis.firebaseapp.com",
  projectId: "altunga-siparis",
  storageBucket: "altunga-siparis.appspot.com",
  messagingSenderId: "152830720353",
  appId: "1:152830720353:web:cc3d3646e6a859c0ca2d20",
  measurementId: "G-JKXK55E39H"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const ding = document.getElementById("ding");
let aktifRol = "";

// --- Gƒ∞Rƒ∞≈û ƒ∞≈ûLEMLERƒ∞ ---
function hazirla(rol) {
  aktifRol = rol;
  document.querySelectorAll('.giris-btn').forEach(b => b.style.display='none');
  document.getElementById("sifreBox").style.display = "block";
}
function iptalGiris() {
  document.getElementById("sifreBox").style.display = "none";
  document.getElementById("sifreInput").value = "";
  document.querySelectorAll('.giris-btn').forEach(b => b.style.display='block');
}
function pinYaz(num) { document.getElementById("sifreInput").value += num; }
function pinSil() { document.getElementById("sifreInput").value = ""; }

async function girisYap() {
  const sifre = document.getElementById("sifreInput").value;
  if (!sifre) return alert("≈ûifre giriniz");

  try {
    const doc = await db.collection("kullanicilar").doc(aktifRol).get();
    if (doc.exists && doc.data().sifre === sifre) {
      localStorage.setItem("adminGiris", "evet");
      localStorage.setItem("adminRol", aktifRol);
      baslatPanel();
    } else { alert("Hatalƒ± ≈ûifre!"); pinSil(); }
  } catch(e) { alert("Hata: " + e.message); }
}

function baslatPanel() {
  document.getElementById("girisOverlay").style.display = "none";
  aktifRol = localStorage.getItem("adminRol");
  document.getElementById("aktifKullanici").innerText = `Giri≈ü: ${aktifRol.toUpperCase()}`;
  listeleSiparisler();
  listeleCagrilar();
}

function cikisYap() {
  localStorage.removeItem("adminGiris");
  location.reload();
}

window.onload = () => { if(localStorage.getItem("adminGiris") === "evet") baslatPanel(); };

// --- Sƒ∞PARƒ∞≈û Lƒ∞STELEME (D√úZELTƒ∞LDƒ∞: name_tr || ad) ---
function listeleSiparisler() {
  const filtre = document.getElementById("durumFiltre").value;
  
  db.collection("siparisler").orderBy("tarih", "desc").onSnapshot(snapshot => {
    const container = document.getElementById("siparisListesi");
    container.innerHTML = ""; 

    snapshot.forEach(doc => {
      const data = doc.data();
      if(filtre !== "T√ºm√º" && data.durum !== filtre) return;

      const tarih = data.tarih?.toDate().toLocaleTimeString("tr-TR", {hour:'2-digit', minute:'2-digit'}) || "";
      
      // *** KRƒ∞Tƒ∞K D√úZELTME ***
      let urunHTML = "";
      if(data.urunler && Array.isArray(data.urunler)) {
          data.urunler.forEach(u => {
              const isim = u.name_tr || u.ad || "Bilinmeyen √úr√ºn"; 
              const adet = u.qty || u.adet || 1; 
              urunHTML += `<div class="product-item"><span>${isim}</span> <b>x${adet}</b></div>`;
          });
      }

      const silBtn = aktifRol === "admin" ? `<button class="btn-action btn-del" onclick="sil('${doc.id}')">Sil</button>` : "";
      
      const card = document.createElement("div");
      card.className = "order-card";
      card.innerHTML = `
        <div class="card-header">
            <span class="masa-badge">${data.masa || '?'} ${data.oda || ''}</span>
            <span class="time-badge">${tarih}</span>
        </div>
        <div class="product-list">${urunHTML}</div>
        <div class="card-footer">
            <span style="font-weight:600; color:var(--text-muted)">${data.durum}</span>
            <span class="total-price">‚Ç∫${data.toplam}</span>
        </div>
        <div class="actions">
            <button class="btn-action btn-prep" onclick="durumGuncelle('${doc.id}', 'Hazirlaniyor')">Hazƒ±rla</button>
            <button class="btn-action btn-done" onclick="durumGuncelle('${doc.id}', 'Teslim')">Teslim</button>
            <button class="btn-action btn-cancel" onclick="durumGuncelle('${doc.id}', 'ƒ∞ptal')">ƒ∞ptal</button>
            ${silBtn}
        </div>
      `;
      container.appendChild(card);
      
      // Yeni sipari≈ü sesi
      if(snapshot.docChanges().some(c => c.type === 'added' && c.doc.id === doc.id)) {
         ding.play().catch(()=>{});
      }
    });
  });
}

// --- √áAƒûRILARI Lƒ∞STELE (KART YAPISI + ALTTA) ---
function listeleCagrilar() {
  db.collection("cagrilar").orderBy("zaman", "desc").onSnapshot(snapshot => {
    const container = document.getElementById("cagriListesi");
    const section = document.getElementById("callsSection");
    
    if(snapshot.empty) {
        section.style.display = "none";
        return;
    }
    section.style.display = "block";
    container.innerHTML = "";
    
    snapshot.forEach(doc => {
        const d = doc.data();
        const saat = d.zaman?.toDate().toLocaleTimeString("tr-TR") || "";
        const tipIcon = d.tip === "Bili≈üim" ? "üíª" : "üëã";
        const tipText = d.tip === "Bili≈üim" ? "Teknik Destek" : "Garson √áaƒürƒ±sƒ±";
        
        if(d.tip === "Bili≈üim" && aktifRol !== "admin") return;

        const card = document.createElement("div");
        card.className = "call-card";
        card.innerHTML = `
            <div class="call-info">
                <span class="call-icon">${tipIcon}</span>
                <div class="call-details">
                    <h3>${tipText}</h3>
                    <p>Masa: <b>${d.masa}</b> ‚Ä¢ ${saat}</p>
                </div>
            </div>
            <button class="btn-action btn-done" style="flex:0; min-width:80px;" onclick="yanitla('${doc.id}')">Tamam</button>
        `;
        container.appendChild(card);
        
        if(snapshot.docChanges().some(c => c.type === 'added' && c.doc.id === doc.id)) {
             ding.play().catch(()=>{});
        }
    });
  });
}

// --- ƒ∞≈ûLEMLER ---
function durumGuncelle(id, durum) {
    if(durum === "Teslim" || durum === "ƒ∞ptal") {
        if(!confirm(`Sipari≈üi ${durum} olarak i≈üaretleyip ar≈üive ta≈üƒ±mak istiyor musun?`)) return;
        
        db.collection("siparisler").doc(id).get().then(doc => {
            const data = doc.data();
            data.durum = durum;
            data.kasiyer = aktifRol;
            data.tarih = new Date();
            
            db.collection("arsiv").add(data).then(() => {
                db.collection("siparisler").doc(id).delete();
                showAlert(`Sipari≈ü ${durum}`);
            });
        });
    } else {
        db.collection("siparisler").doc(id).update({ durum: durum });
    }
}

function yanitla(id) {
    db.collection("cagrilar").doc(id).get().then(doc => {
        db.collection("arsivCagrilar").add({ ...doc.data(), yanitTarih: new Date() }).then(() => {
            db.collection("cagrilar").doc(id).delete();
        });
    });
}

function sil(id) {
    if(confirm("Sipari≈ü kalƒ±cƒ± olarak silinecek?")) db.collection("siparisler").doc(id).delete();
}

function toggleDarkMode() {
    document.body.classList.toggle("dark");
    localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light");
}
if(localStorage.getItem("theme") === "dark") document.body.classList.add("dark");

function showAlert(msg) {
    const box = document.getElementById("customAlert");
    box.innerText = msg; box.classList.add("show");
    setTimeout(() => box.classList.remove("show"), 3000);
}
</script>
</body>
</html>
