<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Altunga ArÅŸiv</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root {
      --bg-body: #f1f5f9; --bg-card: #ffffff; --text-main: #1e293b; 
      --border: #e2e8f0; --primary: #3b82f6; --danger: #ef4444;
    }
    body { font-family: 'Poppins', sans-serif; background: var(--bg-body); color: var(--text-main); padding: 20px; }
    
    h1 { text-align: center; }
    .controls { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 20px; }
    input, button { padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-family: inherit; }
    button { background: var(--primary); color: white; border: none; cursor: pointer; font-weight: 600; }
    
    table { width: 100%; border-collapse: collapse; background: var(--bg-card); border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); }
    th { background: #1e293b; color: white; }
    
    /* Responsive Table */
    @media (max-width: 600px) {
        table, thead, tbody, th, td, tr { display: block; }
        thead tr { position: absolute; top: -9999px; left: -9999px; }
        tr { border: 1px solid #ccc; margin-bottom: 10px; background: white; border-radius: 8px; padding: 10px; }
        td { border: none; position: relative; padding-left: 50%; text-align: right; }
        td:before { position: absolute; left: 10px; width: 45%; padding-right: 10px; white-space: nowrap; text-align: left; font-weight: bold; content: attr(data-label); }
    }
  </style>
</head>
<body>

  <h1>ðŸ“¦ SipariÅŸ ArÅŸivi</h1>
  
  <div class="controls">
    <input type="date" id="dateFilter">
    <button onclick="filtrele()">Tarihe GÃ¶re Ara</button>
    <button onclick="indirPDF()" style="background:#ef4444">PDF Ä°ndir</button>
  </div>

  <table id="arsivTable">
    <thead>
      <tr>
        <th>Tarih/Saat</th>
        <th>Masa</th>
        <th>ÃœrÃ¼nler</th>
        <th>Tutar</th>
        <th>Durum</th>
        <th>Kasiyer</th>
      </tr>
    </thead>
    <tbody id="arsivBody"></tbody>
  </table>

  <h2 style="text-align:center; margin-top:30px">ðŸ“ž Ã‡aÄŸrÄ± ArÅŸivi</h2>
  <table id="cagriTable">
    <thead>
        <tr><th>Tarih</th><th>Tip</th><th>Masa</th></tr>
    </thead>
    <tbody id="cagriBody"></tbody>
  </table>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyC2kYwYuv7drDw0zViXYN4DqpppbtP_coY",
    authDomain: "altunga-siparis.firebaseapp.com",
    projectId: "altunga-siparis",
    storageBucket: "altunga-siparis.appspot.com",
    messagingSenderId: "152830720353",
    appId: "1:152830720353:web:cc3d3646e6a859c0ca2d20",
    measurementId: "G-JKXK55E39H"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // --- VERÄ° Ã‡EKME VE DÃœZELTME ---
  async function veriCek() {
    const tbody = document.getElementById("arsivBody");
    tbody.innerHTML = "<tr><td colspan='6'>YÃ¼kleniyor...</td></tr>";
    
    // Son 100 kaydÄ± Ã§ekelim (Performans iÃ§in)
    const snap = await db.collection("arsiv").orderBy("tarih", "desc").limit(100).get();
    
    tbody.innerHTML = "";
    snap.forEach(doc => {
        const d = doc.data();
        const tarih = d.tarih?.toDate().toLocaleString("tr-TR") || "-";
        
        // HATA DÃœZELTMESÄ°: Hem eski (ad) hem yeni (name_tr) yapÄ±yÄ± destekle
        const urunler = d.urunler.map(u => {
            const ad = u.name_tr || u.ad || "Bilinmeyen";
            const adet = u.qty || u.adet || 1;
            return `${ad} (${adet})`;
        }).join(", ");

        const row = `<tr>
            <td data-label="Tarih">${tarih}</td>
            <td data-label="Masa">${d.masa || ''} ${d.oda || ''}</td>
            <td data-label="ÃœrÃ¼nler">${urunler}</td>
            <td data-label="Tutar">â‚º${d.toplam}</td>
            <td data-label="Durum" style="color:${d.durum=='Ä°ptal'?'red':'green'}">${d.durum}</td>
            <td data-label="Kasiyer">${d.kasiyer || '-'}</td>
        </tr>`;
        tbody.innerHTML += row;
    });

    // Ã‡aÄŸrÄ±larÄ± Ã‡ek
    const cSnap = await db.collection("arsivCagrilar").orderBy("yanitTarih", "desc").limit(50).get();
    const cBody = document.getElementById("cagriBody");
    cBody.innerHTML = "";
    cSnap.forEach(doc => {
        const d = doc.data();
        const t = d.yanitTarih?.toDate().toLocaleString("tr-TR") || "-";
        cBody.innerHTML += `<tr><td data-label="Tarih">${t}</td><td data-label="Tip">${d.tip}</td><td data-label="Masa">${d.masa}</td></tr>`;
    });
  }

  function filtrele() {
      // Tarih filtresi eklenebilir, ÅŸimdilik basit limitli Ã§ekiyoruz
      veriCek();
  }

  function indirPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Altunga SipariÅŸ ArÅŸivi", 10, 10);
      html2canvas(document.getElementById("arsivTable")).then(canvas => {
          const img = canvas.toDataURL("image/png");
          doc.addImage(img, 'PNG', 10, 20, 190, 0);
          doc.save("Arsiv.pdf");
      });
  }

  veriCek();
</script>
</body>
</html>
